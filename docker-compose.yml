version: "3.8"

# Default logging configuration to prevent disk fill from container logs
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "50m"
    max-file: "3"

services:
  # === INFRASTRUCTURE ===
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: polymarket_ml
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    logging: *default-logging

  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 1gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    logging: *default-logging

  # === APPLICATION SERVICES ===
  api:
    build: .
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - POLYMARKET_PRIVATE_KEY=${POLYMARKET_PRIVATE_KEY:-}
      - POLYMARKET_FUNDER_ADDRESS=${POLYMARKET_FUNDER_ADDRESS:-}
      - TRADING_PROXY_URL=${TRADING_PROXY_URL:-}
      - TRADING_PROXY_FALLBACKS=${TRADING_PROXY_FALLBACKS:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    logging: *default-logging

  celery-worker:
    build: .
    command: celery -A src.tasks.celery_app worker -l info -c 8 -Q default,discovery,categorization
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - GRID_API_KEY=B9jpiYiZVSeSEVNor6f6cjKqSnfXtNaANor9siSN
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
    healthcheck:
      test: ["CMD-SHELL", "celery -A src.tasks.celery_app inspect ping -d celery@$$HOSTNAME | grep -q pong"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    logging: *default-logging

  # Dedicated workers for high-frequency snapshot tasks (2 workers for throughput)
  celery-snapshots:
    build: .
    command: celery -A src.tasks.celery_app worker -l info -c 8 -Q snapshots -n snapshots1@%h
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
    healthcheck:
      test: ["CMD-SHELL", "celery -A src.tasks.celery_app inspect ping -d celery@snapshots1@$$HOSTNAME | grep -q pong"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    logging: *default-logging

  celery-snapshots-2:
    build: .
    command: celery -A src.tasks.celery_app worker -l info -c 8 -Q snapshots -n snapshots2@%h
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
    healthcheck:
      test: ["CMD-SHELL", "celery -A src.tasks.celery_app inspect ping -d celery@snapshots2@$$HOSTNAME | grep -q pong"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    logging: *default-logging

  celery-beat:
    build: .
    command: celery -A src.tasks.celery_app beat -l info
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    depends_on:
      - celery-worker
    volumes:
      - .:/app
    restart: unless-stopped
    logging: *default-logging

  websocket-collector:
    build: .
    command: python -m src.collectors.websocket
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
    healthcheck:
      test: ["CMD", "python", "-m", "src.collectors.healthcheck"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 600s  # 10 min warmup before enforcing trade rate
    restart: unless-stopped
    logging: *default-logging

  # Unified CSGO Trading Engine
  # Combines WebSocket + Strategy execution in single process
  # No Redis streams - direct function calls for reliability
  # Prices always from csgo_matches table (CLOB API, 15s refresh)
  csgo-engine:
    build: .
    command: python -m src.csgo.engine.unified
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
    restart: unless-stopped
    logging: *default-logging

  # === STREAMING EXECUTOR (Real-time book imbalance) ===
  streaming-executor:
    build: .
    command: python -m src.streaming.runner
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
      - POLYMARKET_PRIVATE_KEY=${POLYMARKET_PRIVATE_KEY:-}
      - POLYMARKET_FUNDER_ADDRESS=${POLYMARKET_FUNDER_ADDRESS:-}
      - TRADING_PROXY_URL=${TRADING_PROXY_URL:-}
      - TRADING_PROXY_FALLBACKS=${TRADING_PROXY_FALLBACKS:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
    restart: unless-stopped
    logging: *default-logging

  # === EXECUTOR (Polling-based) ===
  executor:
    build: .
    command: python -m src.executor.engine.runner
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/polymarket_ml
      - REDIS_URL=redis://redis:6379/0
      - POLYMARKET_PRIVATE_KEY=${POLYMARKET_PRIVATE_KEY:-}
      - POLYMARKET_FUNDER_ADDRESS=${POLYMARKET_FUNDER_ADDRESS:-}
      - TRADING_PROXY_URL=${TRADING_PROXY_URL:-}
      - TRADING_PROXY_FALLBACKS=${TRADING_PROXY_FALLBACKS:-}
      - EXECUTOR_MODE=${EXECUTOR_MODE:-paper}
      - PAPER_STARTING_BALANCE=${PAPER_STARTING_BALANCE:-10000}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
      - ./config.yaml:/app/config.yaml:ro
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - executor

  # === FRONTEND ===
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - api
    restart: unless-stopped
    logging: *default-logging

  # === MONITORING ===
  flower:
    build: .
    command: celery -A src.tasks.celery_app flower --port=5555
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    ports:
      - "5555:5555"
    depends_on:
      - redis
    restart: unless-stopped
    logging: *default-logging

volumes:
  postgres_data:
  redis_data:
